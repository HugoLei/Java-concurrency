# 线程池使用经验

## 如何合理地配置线程池？

## 合理是什么意思？

1. 线程池大小（占用资源多少）
2. 线程执行耗时
3. 线程响应速度

### 需要考虑哪些因素？

1. 任务的性质：CPU 密集，IO 密集，混合型
2. 任务的执行时长：长，中，短
3. 任务的优先级：高，中，低
4. 任务依赖：是否依赖外部系统资源，如 DB 连接

### 对症下药

#### 线程数量

CPU 密集型：配置尽可能小的线程池，如 Ncpu + 1（防止把 CPU 资源占满） IO 密集型：尽可能多，如2Ncpu（IO 型不是一直占着 CPU，因此可以尽可能多线程，充分利用资源，提升吞吐量） 混合型：尽量拆分成 CPU 密集和 IO，如果两个任务执行时间相差不大，分解后肯定能提高吞吐量。（执行时间相差太大，则没必要）

#### 优先级

可以使用 PriorityBlockingQueue

> 要注意的问题：防止高优先级的任务一直占着，导致低优先级的任务无法执行

#### 执行时间长短

方案一：不同执行时间长短，分给不同的线程池 方案二：使用优先级队列，让短时间的任务优先级高

#### 任务依赖

有任务依赖时，如 DB 连接，相当于 IO 型，可尽量增大线程池

#### 使用有界队列

例如，DB 出问题了，导致连接池的线程都 hang 住，如果是无界队列，那就会无限增长，将内存撑爆。使用有界队列，可以增强稳定性和预警能力。

## 线程池监控

常见监控指标： 1. taskCount: 需要执行的任务数量 2. completedTaskCount：已完成的任务数（&lt;=taskCount） 3. largestPoolSize: 曾经创建过的最大线程数量（用来判断线程池是否曾经满过） 4. getPoolSize: 当前线程数量 5. getActiveCount: 活动线程数量

扩展： 重写beforeExecute\(\)，afterExecute\(\),terminated\(\)方法

> 例如：统计线程执行时间 beforeExecute\(\)里记录任务开始时间，放在 ThreadLocal 里 afterExecute\(\)里获取任务结束时间，计算差值，计算平均运行时间，最大运行时间等

